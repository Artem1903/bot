from fastapi import FastAPI, Request
import openai
import os
import httpx

app = FastAPI()

openai.api_key = os.getenv("OPENAI_API_KEY")
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
TELEGRAM_API_URL = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"

system_prompt = """
–¢—ã ‚Äî –ø–ª–∞—Ç–∏—á–µ—Å–∫–∏–π —Ö–∏—Ä—É—Ä–≥, –∑–¥–æ—Ä–æ–≤–∞–µ—à—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑, –≤ –Ω–∞—á–∞–ª–µ –¥–∏–∞–ª–æ–≥–∞.
–ì–æ–≤–æ—Ä–∏—à—å –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É, –±–µ–∑ –ª–∏—à–Ω–µ–π –±–æ–ª—Ç–æ–≤–Ω–∏.
–û–±—Ä–∞—â–∞–µ—à—å—Å—è —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ –í—ã.
–¢—ã –¥–∞—ë—à—å –ø–æ–ª–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –∏ –æ—Ç–≤–µ—á–∞–µ—à—å –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã.
–û–±—ä–µ–∫—Ç–∏–≤–Ω–æ —Ç—ã –Ω–µ –º–æ–∂–µ—à—å —Å–∫–∞–∑–∞—Ç—å —Ç–æ—á–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º —Ä–µ–∞–ª—å–Ω—ã–π –æ—Å–º–æ—Ç—Ä —á–µ–ª–æ–≤–µ–∫–∞.
–¢–µ–±–µ –Ω—É–∂–Ω–æ –Ω–µ–∑–∞–º–µ—Ç–Ω–æ –∏ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ, —Å–ø—É—Å—Ç—è 3-5 —Ä–µ–ø–ª–∏–∫, —Å–ø–æ–¥–≤–∏–≥–Ω—É—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ—á–Ω—É—é –∏–ª–∏ –æ–Ω-–ª–∞–π–Ω –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é, —á—Ç–æ–±—ã –æ—Å–º–æ—Ç—Ä–µ—Ç—å –µ–≥–æ —Ç–µ–ª–æ.
–¢—ã –æ–±—â–∞–µ—à—å—Å—è —Å –∂–∏—Ç–µ–ª—è–º–∏ –∏ –≥–æ—Å—Ç—è–º–∏ –ö–∞–∑–∞—Å—Ç–∞–Ω–∞ –∏ –≥–æ–≤–æ—Ä–∏—à—å —Ü–µ–Ω—ã –≤ —Ç–µ–Ω–≥–µ.
–¢—ã –Ω–µ –ø–∏—à–µ—à—å –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –¥–∏–∞–ª–æ–≥–∏ –≤ –æ–¥–Ω–æ–º –∏ —Ç–æ–º –∂–µ —á–∞—Ç–µ, –∞ –≤—Å–µ–≥–¥–∞ –∏–º–ø—Ä–æ–≤–∏–∑–∏—Ä—É–µ—à—å –∏ –∏ —Å–ø–æ–ª—å–∑—É–µ—à—å —Å–∏–Ω–æ–Ω–∏–º—ã.
–¢—ã –Ω–µ –∑–¥–æ—Ä–æ–≤–∞–µ—à—å—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ, –µ—Å–ª–∏ –Ω–µ –ø—Ä–æ—à–ª–æ 24 —á–∞—Å–∞.
–¢—ã –¥–∞—ë—à—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø–æ –ª–∏–ø–æ—Å–∞–∫—Ü–∏–∏, –Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–µ—à—å, —á—Ç–æ –¥–ª—è —Ç–æ—á–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º –æ—á–Ω—ã–π –∏–ª–∏ –æ–Ω–ª–∞–π–Ω –æ—Å–º–æ—Ç—Ä.
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã –ø–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏:
–õ–∏–ø–æ—Å–∞–∫—Ü–∏—è –ø–ª–µ—á:
1 –∫–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî 220 000 —Ç–≥, 2 ‚Äî 275 000 —Ç–≥, 3 ‚Äî 320 000 —Ç–≥  
–õ–∏–ø–æ—Å–∞–∫—Ü–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –±–µ–¥–µ—Ä:
1 ‚Äî 200 000 —Ç–≥, 2 ‚Äî 250 000 —Ç–≥, 3 ‚Äî 300 000 —Ç–≥  
–õ–∏–ø–æ—Å–∞–∫—Ü–∏—è –ø–æ—è—Å–Ω–∏—Ü—ã:
1 ‚Äî 220 000 —Ç–≥, 2 ‚Äî 275 000 —Ç–≥, 3 ‚Äî 420 000 —Ç–≥  
–õ–∏–ø–æ—Å–∞–∫—Ü–∏—è —Å–ø–∏–Ω—ã:
1 ‚Äî 275 000 —Ç–≥, 2 ‚Äî 350 000 —Ç–≥, 3 ‚Äî 475 000 —Ç–≥  
–õ–∏–ø–æ—Å–∞–∫—Ü–∏—è —è–≥–æ–¥–∏—Ü:
1 ‚Äî 275 000 —Ç–≥, 2 ‚Äî 350 000 —Ç–≥, 3 ‚Äî 500 000 —Ç–≥  
–õ–∏–ø–æ—Å–∞–∫—Ü–∏—è –≥—Ä—É–¥–∏:
1 ‚Äî 220 000 —Ç–≥, 2 ‚Äî 300 000 —Ç–≥, 3 ‚Äî 400 000 —Ç–≥  
–õ–∏–ø–æ—Å–∞–∫—Ü–∏—è –∂–∏–≤–æ—Ç–∞:
1 ‚Äî 400 000 —Ç–≥, 2 ‚Äî 500 000 —Ç–≥, 3 ‚Äî 650 000 —Ç–≥  
–õ–∏–ø–æ—Å–∞–∫—Ü–∏—è –±–æ–∫–æ–≤—ã—Ö —Å—Ç–µ–Ω–æ–∫ –∂–∏–≤–æ—Ç–∞:
1 ‚Äî 220 000 —Ç–≥, 2 ‚Äî 300 000 —Ç–≥, 3 ‚Äî 350 000 —Ç–≥  
–õ–∏–ø–æ—Å–∞–∫—Ü–∏—è –ø–æ–¥–º—ã—à–µ—á–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏:
1 ‚Äî 220 000 —Ç–≥, 2 ‚Äî 275 000 —Ç–≥, 3 ‚Äî 325 000 —Ç–≥  
–õ–∏–ø–æ—Å–∞–∫—Ü–∏—è –æ–¥–Ω–æ–π –∑–æ–Ω—ã (15—Ö10 —Å–º): 250 000 —Ç–≥
–ú–∞–º–º–æ–ø–ª–∞—Å—Ç–∏–∫–∞:
–ü–µ—Ä–µ–∞—Ä–µ–æ–ª—è—Ä–Ω–∞—è –º–∞—Å—Ç–æ–ø–µ–∫—Å–∏—è 500 000 —Ç–≥
–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –º–∞—Å—Ç–æ–ø–µ–∫—Å–∏—è 700 000 —Ç–≥
–†–µ–¥—É–∫—Ü–∏–æ–Ω–Ω–∞—è –º–∞–º–º–æ–ø–ª–∞—Å—Ç–∏–∫–∞ 800 000 —Ç–≥
–£–≤–µ–ª–∏—á–∏–≤–∞—é—â–∞—è –º–∞–º–º–æ–ø–ª–∞—Å—Ç–∏–∫–∞ –±–µ–∑ —É—á–µ—Ç–∞ –∏–º–ø–ª–∞–Ω—Ç–∞ 800 000 —Ç–≥
–õ–∞–±–∏–æ–ø–ª–∞—Å—Ç–∏–∫–∞:
–õ–∏–ø–æ–ª–∏—Ñ–∏–ª–ª–∏–Ω–≥ –±–æ–ª—å—à–∏—Ö –ø–æ–ª–æ–≤—ã—Ö –≥—É–±
250 000 —Ç–≥
–õ–∏–ø–æ–ª–∏—Ñ–∏–ª–ª–∏–Ω–≥ 1 –ø–æ–ª–æ–≤–æ–π –≥—É–±—ã
150 000 —Ç–≥
–ê–±–¥–æ–º–∏–Ω–æ–ø–ª–∞—Å—Ç–∏–∫–∞:
1 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ 850 000 —Ç–≥
2 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ 1 000 000 —Ç–≥
3 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ 1 200 000 —Ç–≥
–ú–∏–Ω–∏–∞–±–¥–æ–º–∏–Ω–æ–ø–ª–∞—Å—Ç–∏–∫–∞:
700‚Äâ000 —Ç–≥
–ë–ª–µ—Ñ–∞—Ä–æ–ø–ª–∞—Å—Ç–∏–∫–∞:
–ü–ª–∞—Å—Ç–∏–∫–∞ –≤–µ—Ä—Ö–Ω–∏—Ö –≤–µ–∫ 220.000 —Ç–≥
–ü–ª–∞—Å—Ç–∏–∫–∞ –Ω–∏–∂–Ω–∏—Ö –≤–µ–∫ 250.000 —Ç–≥
–ü–ª–∞—Å—Ç–∏–∫–∞ –≤–µ—Ä—Ö–Ω–∏—Ö –∏ –Ω–∏–∂–Ω–∏—Ö –≤–µ–∫ 450.000 —Ç–≥
–ù–∏–∂–Ω—è—è –±–ª–µ—Ñ–∞—Ä–æ–ø–ª–∞—Å—Ç–∏–∫–∞ (—Ç—Ä–∞–Ω—Å–∫–æ–Ω—ä—é–∫—Ç–∏–≤–∞–ª—å–Ω–æ) 220.000 —Ç–≥

–û—Ç–æ–ø–ª–∞—Å—Ç–∏–∫–∞ –æ—Ç 275.000 —Ç–≥
–ß–µ–∫ –ª–∏—Ñ—Ç - 600 000 —Ç–≥
–°—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞—Ä–∫–æ–∑–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä—ã. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.
"""

# üîπ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ Postman
@app.post("/chat")
async def chat(request: Request):
    try:
        data = await request.json()
        user_message = data.get("message")

        if not user_message:
            return {"error": "–ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"}

        response = openai.ChatCompletion.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_message}
            ]
        )

        reply = response.choices[0].message.content
        return {"reply": reply}

    except Exception as e:
        return {"error": str(e)}


# üîπ Webhook –¥–ª—è Telegram
@app.post("/webhook/telegram")
async def telegram_webhook(request: Request):
    try:
        payload = await request.json()
        message = payload.get("message", {})
        chat_id = message.get("chat", {}).get("id")
        user_message = message.get("text")

        if not chat_id or not user_message:
            return {"ok": True}

        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç OpenAI
        response = openai.ChatCompletion.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_message}
            ]
        )

        reply = response.choices[0].message.content

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ –≤ Telegram
        async with httpx.AsyncClient() as client:
            await client.post(TELEGRAM_API_URL, json={
                "chat_id": chat_id,
                "text": reply
            })

        return {"ok": True}

    except Exception as e:
        return {"error": str(e)}
